// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Employee {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  isManager Boolean  @default(false)
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  account             Account?
  managerAllotments   ManagerAllotment[]
  sentAwards          LedgerTransaction[]  @relation("ManagerAwards")
  sentTransfers       LedgerTransaction[]  @relation("SentTransfers")
  receivedTransfers   LedgerTransaction[]  @relation("ReceivedTransfers")
  wellnessSubmissions WellnessSubmission[]
  reviewedSubmissions WellnessSubmission[] @relation("ReviewedBy")
  peerTransferLimits  PeerTransferLimit[]
  pendingTransfers    PendingTransfer[]
  purchases           StorePurchaseOrder[]
  wishlistItems       WishlistItem[]
  goals               Goal[]
  fulfilledPurchases  StorePurchaseOrder[] @relation("FulfilledPurchases")
  campaignsCreated    Campaign[]           @relation("CampaignsCreated")
  // Game relations
  gamesCreated        Game[]               @relation("GameCreator")
  gameParticipations  GameParticipant[]
  gameStats           GameStats?
  dailyBonusSpins     DailyBonusSpin[]
  jackpotContributions JackpotContribution[]
}

model Account {
  id               String   @id @default(uuid())
  employeeId       String   @unique
  balance          Decimal  @default(0) @db.Decimal(10, 2)
  allotmentBalance Decimal  @default(0) @db.Decimal(10, 2) // Manager's allotment balance for giving awards
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  employee     Employee            @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  transactions LedgerTransaction[]
}

model LedgerTransaction {
  id                   String            @id @default(uuid())
  accountId            String
  transactionType      TransactionType
  amount               Decimal           @db.Decimal(10, 2)
  status               TransactionStatus @default(pending)
  description          String?           @db.Text
  sourceEmployeeId     String?
  targetEmployeeId     String?
  wellnessSubmissionId String?           @unique
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  postedAt             DateTime?

  account            Account             @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sourceEmployee     Employee?           @relation("ManagerAwards", fields: [sourceEmployeeId], references: [id], map: "LedgerTransaction_sourceEmployeeId_manager_fkey")
  transferSender     Employee?           @relation("SentTransfers", fields: [sourceEmployeeId], references: [id], map: "LedgerTransaction_sourceEmployeeId_transfer_fkey")
  transferReceiver   Employee?           @relation("ReceivedTransfers", fields: [targetEmployeeId], references: [id])
  wellnessSubmission WellnessSubmission? @relation(fields: [wellnessSubmissionId], references: [id])
  purchaseOrder      StorePurchaseOrder?
  chatCommandAudits  ChatCommandAudit[]

  @@index([accountId])
  @@index([status])
  @@index([createdAt])
  @@index([sourceEmployeeId])
  @@index([targetEmployeeId])
}

enum TransactionType {
  manager_award
  peer_transfer_sent
  peer_transfer_received
  wellness_reward
  adjustment
  store_purchase
  allotment_deposit // Admin deposits funds into manager's allotment balance
  // Game transaction types
  game_bet
  game_win
  game_refund
  jackpot_contribution
  jackpot_win
  daily_bonus
}

enum TransactionStatus {
  pending
  posted
  rejected
}

enum ChatProvider {
  google_chat
}

enum ChatCommandStatus {
  received
  authorized
  rejected
  failed
  succeeded
}

model ChatCommandAudit {
  id            String            @id @default(uuid())
  provider      ChatProvider
  eventType     String?
  messageId     String?
  spaceName     String?
  threadName    String?
  userEmail     String?
  commandText   String?
  commandName   String?
  status        ChatCommandStatus
  transactionId String?
  errorMessage  String?           @db.Text
  createdAt     DateTime          @default(now())

  transaction LedgerTransaction? @relation(fields: [transactionId], references: [id])

  @@index([userEmail, createdAt])
  @@index([transactionId])
}

model ManagerAllotment {
  id          String     @id @default(uuid())
  managerId   String
  periodType  PeriodType
  amount      Decimal    @db.Decimal(10, 2)
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  manager Employee @relation(fields: [managerId], references: [id], onDelete: Cascade)

  @@index([managerId, periodStart, periodEnd])
}

enum PeriodType {
  monthly
  quarterly
}

enum PendingTransferStatus {
  pending
  claimed
  cancelled
}

model WellnessTask {
  id               String        @id @default(uuid())
  name             String
  description      String?       @db.Text
  instructions     String?       @db.Text
  coinValue        Decimal       @db.Decimal(10, 2)
  frequencyRule    FrequencyRule
  requiresApproval Boolean       @default(true)
  formTemplateUrl  String?
  maxRewardedUsers Int?
  isActive         Boolean       @default(true)
  tags             String[]      @default([]) // For filtering/categorizing tasks
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  submissions   WellnessSubmission[]
  campaignTasks CampaignTask[]

  @@index([isActive])
}

enum FrequencyRule {
  one_time
  annual
  quarterly
}

model WellnessSubmission {
  id              String           @id @default(uuid())
  employeeId      String
  wellnessTaskId  String
  documentUrl     String
  status          SubmissionStatus @default(pending)
  rejectionReason String?          @db.Text
  reviewedById    String?
  reviewedAt      DateTime?
  submittedAt     DateTime         @default(now())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  employee     Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  wellnessTask WellnessTask       @relation(fields: [wellnessTaskId], references: [id])
  reviewedBy   Employee?          @relation("ReviewedBy", fields: [reviewedById], references: [id])
  transaction  LedgerTransaction?

  @@index([employeeId])
  @@index([status])
  @@index([wellnessTaskId])
}

enum SubmissionStatus {
  pending
  approved
  rejected
}

model PeerTransferLimit {
  id          String     @id @default(uuid())
  employeeId  String
  periodType  PeriodType
  maxAmount   Decimal    @db.Decimal(10, 2)
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, periodStart, periodEnd])
}

model PendingTransfer {
  id                 String                @id @default(uuid())
  senderEmployeeId   String
  recipientEmail     String
  amount             Decimal               @db.Decimal(10, 2)
  message            String?               @db.Text
  status             PendingTransferStatus @default(pending)
  senderTransactionId String               @unique
  createdAt          DateTime              @default(now())
  claimedAt          DateTime?

  senderEmployee Employee @relation(fields: [senderEmployeeId], references: [id], onDelete: Cascade)

  @@index([recipientEmail, status])
}

model EmailTemplate {
  id        String   @id @default(uuid())
  key       String   @unique
  name      String
  subject   String
  html      String   @db.Text
  isEnabled Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum StoreProductSource {
  custom
  amazon
  amazon_list
}

model StoreProduct {
  id            String             @id @default(uuid())
  name          String
  description   String?            @db.Text
  imageUrls     String[]           @default([])
  amazonUrl     String?
  amazonAsin    String?            @unique
  source        StoreProductSource
  priceUsd      Decimal?           @db.Decimal(10, 2)
  priceGuincoin Decimal            @db.Decimal(10, 2)
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  purchases    StorePurchaseOrder[]
  wishlistItems WishlistItem[]
  goals        Goal[]

  @@index([isActive])
  @@index([source])
}

enum PurchaseOrderStatus {
  pending
  fulfilled
  cancelled
}

model StorePurchaseOrder {
  id                  String              @id @default(uuid())
  employeeId          String
  productId           String
  transactionId       String              @unique
  status              PurchaseOrderStatus @default(pending)
  fulfilledById       String?
  fulfilledAt         DateTime?
  shippingAddress     String?             @db.Text
  trackingNumber      String?
  notes               String?             @db.Text
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  employee    Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  product     StoreProduct @relation(fields: [productId], references: [id])
  transaction LedgerTransaction @relation(fields: [transactionId], references: [id])
  fulfilledBy Employee?   @relation("FulfilledPurchases", fields: [fulfilledById], references: [id])

  @@index([employeeId])
  @@index([status])
  @@index([productId])
}

model WishlistItem {
  id        String   @id @default(uuid())
  employeeId String
  productId  String
  createdAt DateTime @default(now())

  employee Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  product  StoreProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([employeeId, productId])
  @@index([employeeId])
}

model Goal {
  id            String   @id @default(uuid())
  employeeId    String
  productId     String
  targetAmount  Decimal  @db.Decimal(10, 2)
  currentAmount Decimal  @default(0) @db.Decimal(10, 2)
  isAchieved    Boolean  @default(false)
  achievedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  employee Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  product  StoreProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([isAchieved])
}

// =====================
// Campaign Management
// =====================

enum CampaignStatus {
  draft
  scheduled
  active
  completed
  archived
}

model Campaign {
  id              String         @id @default(uuid())
  name            String
  description     String?        @db.Text
  slug            String         @unique
  status          CampaignStatus @default(draft)
  startDate       DateTime?      // Optional - leave empty for no date restriction
  endDate         DateTime?      // Optional - leave empty for no date restriction
  theme           Json           // CampaignTheme object: { primaryColor, secondaryColor, accentColor, navTextColor, etc. }
  bannerImageUrl  String?
  posterImageUrl  String?
  emailBannerUrl  String?
  chatImageUrl    String?
  aiPromptUsed    String?        @db.Text
  emailSentAt     DateTime?
  chatPostedAt    DateTime?
  createdById     String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  createdBy     Employee       @relation("CampaignsCreated", fields: [createdById], references: [id])
  campaignTasks CampaignTask[]
  banners       Banner[]
  gameAssets    GameAsset[]

  @@index([status])
  @@index([startDate, endDate])
}

// =====================
// Banner System
// =====================

enum BannerPosition {
  sidebar_left
  sidebar_right
  header
  footer
  background
}

model Banner {
  id              String         @id @default(uuid())
  name            String
  position        BannerPosition
  campaignId      String?
  imageUrl        String?
  isAiGenerated   Boolean        @default(false)
  aiPromptUsed    String?        @db.Text
  width           Int
  height          Int
  isActive        Boolean        @default(true)
  textOverlay     Json?          // {text, fontFamily, fontSize, fontColor, fontWeight, position, backgroundColor, padding}
  imagePositionX  String         @default("center") // left, center, right - for object-position CSS
  imagePositionY  String         @default("center") // top, center, bottom - for object-position CSS
  showOnDashboard Boolean        @default(true)
  showOnTransfers Boolean        @default(true)
  showOnStore     Boolean        @default(true)
  showOnWellness  Boolean        @default(true)
  showOnManager   Boolean        @default(true)
  displayOrder    Int            @default(0)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  campaign        Campaign?      @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([position, isActive])
  @@index([campaignId])
}

model CampaignTask {
  id              String   @id @default(uuid())
  campaignId      String
  wellnessTaskId  String?  // null = campaign-exclusive task (not linked to existing wellness task)
  name            String?  // Only for campaign-exclusive tasks
  description     String?  @db.Text
  coinValue       Decimal? @db.Decimal(10, 2) // Override for exclusive tasks
  bonusMultiplier Decimal  @default(1) @db.Decimal(3, 2) // Multiplier for linked tasks (e.g., 2.0 = double coins)
  displayOrder    Int      @default(0)
  createdAt       DateTime @default(now())

  campaign     Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  wellnessTask WellnessTask? @relation(fields: [wellnessTaskId], references: [id])

  @@unique([campaignId, wellnessTaskId])
  @@index([campaignId])
}

// =====================
// Gaming System
// =====================

enum GameType {
  // Instant Win - Tier 1 (Launch)
  coin_flip
  dice_roll
  spin_wheel
  higher_lower
  scratch_card
  daily_bonus
  // Instant Win - Tier 2 (Post-Launch)
  lucky_numbers
  plinko
  crash
  mines
  // Strategic
  trivia
  prediction
  // P2P / Betting
  head_to_head
  pool_bet
  // Fantasy & Sports
  fantasy_football
  super_bowl_pool
  bracket_challenge
}

enum GameStatus {
  pending     // Waiting for participants or action
  active      // Game in progress
  completed   // Game finished, payouts processed
  cancelled   // Game cancelled, bets refunded
  expired     // Time limit reached
}

enum GameTxType {
  bet
  payout
  refund
  jackpot_in
  jackpot_out
}

enum JackpotType {
  rolling   // Accumulates until won
  daily     // Resets daily
  weekly    // Resets weekly
  event     // One-time event jackpot
}

enum GameAssetType {
  background
  card_back
  overlay
  frame
}

model Game {
  id              String       @id @default(uuid())
  type            GameType
  status          GameStatus   @default(pending)

  // Timing
  createdAt       DateTime     @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  expiresAt       DateTime?

  // Game Configuration
  config          Json         // Type-specific settings (minBet, maxBet, etc.)

  // Results
  result          Json?        // Outcome data (varies by game type)
  serverSeed      String?      // For provably fair verification
  serverSeedHash  String?      // Hash shown before game
  clientSeed      String?      // Player-provided or auto-generated
  nonce           Int          @default(0)

  // Creator
  createdById     String
  createdBy       Employee     @relation("GameCreator", fields: [createdById], references: [id])

  // Relations
  participants         GameParticipant[]
  transactions         GameTransaction[]
  jackpotContributions JackpotContribution[]

  @@index([type, status])
  @@index([createdById])
  @@index([createdAt])
  @@index([status])
}

model GameParticipant {
  id              String    @id @default(uuid())
  gameId          String
  employeeId      String

  // Bet Details
  betAmount       Decimal   @db.Decimal(10, 2)
  prediction      Json?     // Player's choice (heads/tails, number, team, etc.)

  // Outcome
  payout          Decimal?  @db.Decimal(10, 2)
  isWinner        Boolean?

  // Timing
  joinedAt        DateTime  @default(now())

  // Relations
  game            Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  employee        Employee  @relation(fields: [employeeId], references: [id])

  @@unique([gameId, employeeId])
  @@index([employeeId])
  @@index([gameId])
}

model GameTransaction {
  id              String          @id @default(uuid())
  gameId          String
  participantId   String?
  transactionId   String          @unique
  type            GameTxType
  amount          Decimal         @db.Decimal(10, 2)
  createdAt       DateTime        @default(now())

  game            Game            @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([transactionId])
}

model Jackpot {
  id                String      @id @default(uuid())
  name              String      // "Team Jackpot", "Weekly Mega Jackpot"
  type              JackpotType @default(rolling)

  // Balance
  balance           Decimal     @default(0) @db.Decimal(10, 2)

  // Configuration
  contributionRate  Decimal     @default(1.0) @db.Decimal(5, 2) // Multiplier for contributions
  minWinAmount      Decimal?    @db.Decimal(10, 2)

  // Status
  isActive          Boolean     @default(true)
  lastWonAt         DateTime?
  lastWonBy         String?
  lastWonAmount     Decimal?    @db.Decimal(10, 2)

  // Timing
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  contributions     JackpotContribution[]

  @@index([isActive])
  @@index([type])
}

model JackpotContribution {
  id              String    @id @default(uuid())
  jackpotId       String
  gameId          String?
  employeeId      String
  amount          Decimal   @db.Decimal(10, 2)
  createdAt       DateTime  @default(now())

  jackpot         Jackpot   @relation(fields: [jackpotId], references: [id], onDelete: Cascade)
  game            Game?     @relation(fields: [gameId], references: [id], onDelete: SetNull)
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([jackpotId])
  @@index([employeeId])
  @@index([gameId])
  @@index([createdAt])
}

model GameConfig {
  id                    String    @id @default(uuid())
  gameType              GameType  @unique
  enabled               Boolean   @default(true)
  minBet                Decimal   @default(1) @db.Decimal(10, 2)
  maxBet                Decimal   @default(500) @db.Decimal(10, 2)
  payoutMultiplier      Decimal?  @db.Decimal(5, 2) // Override default if set
  jackpotContributionRate Decimal @default(0.05) @db.Decimal(5, 4) // 5% default
  availableInChat       Boolean   @default(true)
  availableOnWeb        Boolean   @default(true)
  displayOrder          Int       @default(0)
  customConfig          Json?     // Game-specific overrides
  updatedAt             DateTime  @updatedAt

  @@index([enabled])
}

model GameAsset {
  id              String        @id @default(uuid())
  campaignId      String?
  gameType        GameType
  assetType       GameAssetType
  imageUrl        String
  width           Int
  height          Int
  promptUsed      String?       @db.Text
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())

  campaign        Campaign?     @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@unique([campaignId, gameType, assetType])
  @@index([gameType, isActive])
  @@index([campaignId])
}

model GameStats {
  id                String    @id @default(uuid())
  employeeId        String    @unique

  // Overall Stats
  gamesPlayed       Int       @default(0)
  gamesWon          Int       @default(0)
  totalBet          Decimal   @default(0) @db.Decimal(12, 2)
  totalWon          Decimal   @default(0) @db.Decimal(12, 2)
  netProfit         Decimal   @default(0) @db.Decimal(12, 2)

  // Streaks
  currentWinStreak  Int       @default(0)
  longestWinStreak  Int       @default(0)

  // By Game Type (JSON object)
  statsByGame       Json      @default("{}")

  // Jackpot stats
  jackpotsWon       Int       @default(0)
  totalJackpotWinnings Decimal @default(0) @db.Decimal(12, 2)

  updatedAt         DateTime  @updatedAt

  employee          Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model DailyBonusSpin {
  id              String    @id @default(uuid())
  employeeId      String
  prize           Decimal   @db.Decimal(10, 2)
  segmentIndex    Int
  createdAt       DateTime  @default(now())

  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, createdAt])
}

// =====================
// System Settings (for Campaign Studio)
// =====================

model SystemSettings {
  id          String   @id @default("system")
  themeMode   String   @default("campaign") // 'manual' or 'campaign'
  manualTheme Json?    // CampaignTheme object when in manual mode
  updatedAt   DateTime @updatedAt
}
